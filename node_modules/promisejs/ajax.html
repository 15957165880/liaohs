<!doctype html>
<html>
    <head><title>Promise</title>
        <script src="./promise.js"></script>
    </head>
<body>
    <h1 id="h1"></h1>
    <h2 id="h2"></h2>
    <div id="content"></div>
    <script>
        document.getElementById('h1').innerHTML = "Ajaxed promise";
        function getAjax(url) {
            return Promise().defer(function() {
        		var xhr = new XMLHttpRequest, timer;

                /* This will be called after getAjax(...) returns */
                xhr.onreadystatechange = function() {
                	if(xhr.readyState === 4 && xhr.status) {
                		clearTimeout(timer);
                		if(xhr.status > 399) promise.reject(xhr.statusText);
                        else promise.fulfill(xhr.responseText);   	
                	}
                }

                /* send an asynchronous XmlHttp GET request */
                xhr.open("GET",url,true);
                xhr.send(null);

                /* set a timeout that fires after 5 secs */
                timer = setTimeout(function() { 
                    xhr.abort();
                    throw "operation timedout!"; 
                },5000);
            });
        }

        /* When the response arives it calls either the fulfilled block or the rejected block. */
        getAjax("http://earthquake.usgs.gov/earthquakes/feed/geojson/significant/month").then(function(value){
            /* validates JSON data */
            var data = JSON.parse(value);
        	document.getElementById('h2').innerHTML = "Fulfilled";
            document.getElementById('content').innerHTML = JSON.stringify(data);
        },function(reason){
        	document.getElementById('h2').innerHTML = "Rejected";
            document.getElementById('content').innerHTML = reason;
        });
    </script>
</body>
</html>